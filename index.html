<!doctype html>
<html lang="id" data-theme="neon">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retail Cortex • Owner Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --r: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --ease: cubic-bezier(.2,.8,.2,1);
      --dur: 260ms;
      --max: 1200px;
      --gap: 14px;

      --bg: #070A12;
      --bg2:#0A1022;
      --card: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.42);
      --accent: #2EE9FF;
      --accent2:#9B5CFF;
      --good:#34F6A2;
      --bad:#FF4D7D;
      --warn:#FFCC66;
      --link:#7DE7FF;
      --glow: 0 0 0 rgba(46,233,255,0);
    }

    html[data-theme="light"] {
      --bg: #F6F8FC;
      --bg2:#FFFFFF;
      --card: #FFFFFF;
      --text: rgba(15,23,42,.92);
      --muted: rgba(15,23,42,.60);
      --muted2: rgba(15,23,42,.42);
      --accent: #2563EB;
      --accent2:#7C3AED;
      --good:#16A34A;
      --bad:#DC2626;
      --warn:#D97706;
      --link:#1D4ED8;
      --shadow: 0 10px 26px rgba(15,23,42,.10);
    }

    html[data-theme="neon"] { --glow: 0 0 28px rgba(46,233,255,.16); }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 12% -10%, rgba(155,92,255,.22), transparent 60%),
                  radial-gradient(1200px 700px at 90% 0%, rgba(46,233,255,.20), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
      min-height: 100vh;
    }

    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .wrap { max-width: var(--max); margin: 0 auto; padding: 18px 14px 42px; }

    .topbar {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.05));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    html[data-theme="light"] .topbar { background: rgba(255,255,255,.75); border-bottom: 1px solid rgba(15,23,42,.08); }

    .topbarInner {
      max-width: var(--max);
      margin: 0 auto;
      padding: 14px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img {
      width: 44px; height: 44px; object-fit: contain;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--glow);
    }
    html[data-theme="light"] .brand img { background: #fff; border: 1px solid rgba(15,23,42,.10); box-shadow:none; }

    .titleBlock { display: grid; gap: 2px; }
    .titleBlock .kicker { font-size: 12px; letter-spacing: .12em; text-transform: uppercase; color: var(--muted); }
    .titleBlock .title { font-size: 16px; font-weight: 800; }

    .actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }

    .pill {
      display: inline-flex; align-items:center; gap: 8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted); font-size: 12px;
    }
    html[data-theme="light"] .pill { border: 1px solid rgba(15,23,42,.12); background: rgba(15,23,42,.04); }

    .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--warn); box-shadow: 0 0 0 4px rgba(255,204,102,.12); }
    .dot.ok { background: var(--good); box-shadow: 0 0 0 4px rgba(52,246,162,.14); }
    .dot.bad { background: var(--bad); box-shadow: 0 0 0 4px rgba(255,77,125,.14); }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 700;
      transition: transform var(--dur) var(--ease), background var(--dur) var(--ease), border var(--dur) var(--ease);
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.12); }
    html[data-theme="light"] .btn { border: 1px solid rgba(15,23,42,.14); background: rgba(15,23,42,.05); color: rgba(15,23,42,.92); }
    html[data-theme="light"] .btn:hover { background: rgba(15,23,42,.08); }

    .toggle { display:flex; align-items:center; gap:6px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); padding: 6px; border-radius: 999px; }
    html[data-theme="light"] .toggle { border: 1px solid rgba(15,23,42,.12); background: rgba(15,23,42,.04); }
    .toggle button {
      border: 0; background: transparent;
      color: var(--muted); font-weight: 800;
      padding: 8px 10px; border-radius: 999px; cursor:pointer;
      transition: background var(--dur) var(--ease), color var(--dur) var(--ease);
      font-size: 12px;
    }
    .toggle button.active { background: linear-gradient(135deg, rgba(46,233,255,.22), rgba(155,92,255,.18)); color: var(--text); box-shadow: var(--glow); }
    html[data-theme="light"] .toggle button.active { background: rgba(37,99,235,.12); box-shadow:none; color: rgba(15,23,42,.92); }

    .grid { display:grid; gap: var(--gap); }
    .kpis { grid-template-columns: repeat(4, 1fr); }
    @media (max-width: 980px) { .kpis { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px) { .kpis { grid-template-columns: 1fr; } .actions { justify-content:flex-start; } }

    .card { border-radius: var(--r); background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); box-shadow: var(--shadow); overflow: hidden; }
    html[data-theme="light"] .card { background: #fff; border: 1px solid rgba(15,23,42,.12); }

    .cardInner { padding: 14px 14px; }
    .kpiTitle { font-size: 12px; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; }
    .kpiValue { margin-top: 8px; font-size: 28px; font-weight: 900; letter-spacing: -0.02em; }
    .kpiSub { margin-top: 6px; font-size: 12px; color: var(--muted2); display:flex; justify-content: space-between; gap:10px; }

    .badge { display:inline-flex; align-items:center; gap:6px; border-radius: 999px; padding: 4px 8px; font-size: 12px; font-weight: 800; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--muted); white-space: nowrap; }
    html[data-theme="light"] .badge { border: 1px solid rgba(15,23,42,.12); background: rgba(15,23,42,.04); }
    .badge.good { color: var(--good); border-color: rgba(52,246,162,.22); background: rgba(52,246,162,.08); }
    .badge.bad { color: var(--bad); border-color: rgba(255,77,125,.22); background: rgba(255,77,125,.08); }

    .growth { grid-template-columns: repeat(4, 1fr); }
    @media (max-width: 980px) { .growth { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px) { .growth { grid-template-columns: 1fr; } }
    .growHeader { display:flex; justify-content: space-between; gap: 12px; }
    .growHeader .h { font-size: 13px; font-weight: 900; letter-spacing: .08em; text-transform: uppercase; }
    .growMeta { margin-top: 10px; display:grid; gap: 8px; }
    .growRow { display:flex; justify-content: space-between; gap: 10px; font-size: 13px; color: var(--muted); }
    .growRow b { color: var(--text); font-weight: 900; }

    .charts { grid-template-columns: 2fr 1fr; }
    @media (max-width: 980px) { .charts { grid-template-columns: 1fr; } }
    .chartWrap { padding: 14px; }
    .chartTitle { display:flex; justify-content: space-between; gap:10px; margin-bottom: 10px; align-items:center; }
    .chartTitle h3 { margin:0; font-size: 14px; letter-spacing:.08em; text-transform: uppercase; color: var(--muted); }
    .filters { display:flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .chip { cursor:pointer; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--muted); border-radius: 999px; padding: 7px 10px; font-weight: 800; font-size: 12px; user-select:none; }
    .chip.active { background: linear-gradient(135deg, rgba(46,233,255,.22), rgba(155,92,255,.18)); color: var(--text); box-shadow: var(--glow); }

    .tableHead { display:flex; justify-content: space-between; gap:10px; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.08); }
    html[data-theme="light"] .tableHead { border-bottom: 1px solid rgba(15,23,42,.08); }
    .tableHead h3 { margin:0; font-size: 14px; letter-spacing:.08em; text-transform: uppercase; color: var(--muted); }
    .tableTools { display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .inp { border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text); border-radius: 12px; padding: 9px 10px; outline:none; min-width: 220px; font-weight:700; }
    html[data-theme="light"] .inp { border: 1px solid rgba(15,23,42,.14); background: rgba(15,23,42,.04); color: rgba(15,23,42,.92); }

    .tableWrap { overflow:auto; max-height: 520px; }
    table { width:100%; border-collapse: separate; border-spacing:0; min-width: 980px; font-size: 13px; }
    thead th { position: sticky; top: 0; z-index: 2; text-align:left; padding: 10px 12px; color: var(--muted); background: rgba(0,0,0,.22); border-bottom: 1px solid rgba(255,255,255,.10); backdrop-filter: blur(10px); }
    html[data-theme="light"] thead th { background: rgba(255,255,255,.92); border-bottom: 1px solid rgba(15,23,42,.10); }
    tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,.06); color: var(--text); vertical-align: top; }
    html[data-theme="light"] tbody td { border-bottom: 1px solid rgba(15,23,42,.08); }
    tbody tr:nth-child(2n) td { background: rgba(255,255,255,.02); }
    html[data-theme="light"] tbody tr:nth-child(2n) td { background: rgba(15,23,42,.02); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .right { text-align:right; }
    .small { font-size: 12px; color: var(--muted); }
    .linkBtn { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); font-weight:900; color: var(--text); }
    html[data-theme="light"] .linkBtn { border:1px solid rgba(15,23,42,.12); background: rgba(15,23,42,.04); color: rgba(15,23,42,.92); }
    .summary { max-width: 480px; white-space: pre-line; }

    .login { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:22px 14px; }
    .loginCard { width:min(520px,100%); border-radius:24px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); overflow:hidden; }
    html[data-theme="light"] .loginCard { background:#fff; border: 1px solid rgba(15,23,42,.12); }
    .loginHero { padding:22px 18px 12px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; }
    .loginHero img { width:92px; height:92px; object-fit:contain; border-radius:22px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); box-shadow: var(--glow); }
    html[data-theme="light"] .loginHero img { background:#fff; box-shadow:none; }
    .loginHero h1 { margin:4px 0 0; font-size:20px; font-weight:900; letter-spacing:-0.02em; }
    .loginHero p { margin:0; color: var(--muted); font-size:13px; }
    .loginBody { padding:16px 18px 20px; display:grid; gap:10px; }
    .row { display:grid; gap:8px; }
    label { font-size: 12px; color: var(--muted); letter-spacing:.08em; text-transform:uppercase; font-weight:800; }
    .field { border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text); border-radius:14px; padding:12px 12px; outline:none; font-weight:800; }
    html[data-theme="light"] .field { border:1px solid rgba(15,23,42,.14); background: rgba(15,23,42,.04); color: rgba(15,23,42,.92); }
    .loginBtns { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .primary { background: linear-gradient(135deg, rgba(46,233,255,.18), rgba(155,92,255,.14)); border-color: rgba(46,233,255,.22); }
    html[data-theme="light"] .primary { background: rgba(37,99,235,.12); border-color: rgba(37,99,235,.22); }
    .err { color: var(--bad); font-weight:900; font-size:12px; display:none; }
    .hint { margin-top: 8px; font-size:12px; color: var(--muted2); }

    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px; z-index: 99; display:none;
      padding: 10px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color: var(--text);
      box-shadow: var(--shadow);
      font-weight: 900; font-size: 12px;
    }
    html[data-theme="light"] .toast { background: rgba(255,255,255,.90); border:1px solid rgba(15,23,42,.10); color: rgba(15,23,42,.92); }

    .footer { margin-top: 18px; color: var(--muted2); font-size: 12px; text-align:center; padding: 14px 0 0; }
  </style>
</head>

<body>
  <section id="loginPage" class="login">
    <div class="loginCard">
      <div class="loginHero">
        <img src="retail-cortex-logo.png" alt="Retail Cortex" onerror="this.style.display='none'">
        <h1>OWNER ACCESS</h1>
        <p>Retail Cortex • Dashboard (Light / Night Neon)</p>
      </div>
      <div class="loginBody">
        <div class="row">
          <label>Username</label>
          <input id="username" class="field" autocomplete="username" placeholder="brandon26">
        </div>
        <div class="row">
          <label>PIN</label>
          <input id="pin" class="field" type="password" inputmode="numeric" autocomplete="current-password" placeholder="••••••">
        </div>
        <div class="loginBtns">
          <button id="btnLogin" class="btn primary" style="flex:1">Masuk Dashboard</button>
          <button id="btnTheme" class="btn" title="Toggle Light/Neon">Toggle Mode</button>
        </div>
        <div id="loginErr" class="err"></div>
        <div class="hint">Login di file ini client-side.</div>
      </div>
    </div>
  </section>

  <div id="app" style="display:none;">
    <div class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <img src="retail-cortex-logo.png" alt="Retail Cortex" onerror="this.style.display='none'">
          <div class="titleBlock">
            <div class="kicker">Owner Dashboard</div>
            <div class="title">Retail Cortex • Income Monitor</div>
          </div>
        </div>

        <div class="actions">
          <div class="toggle" aria-label="Mode toggle">
            <button id="modeLight" type="button">☀ Light</button>
            <button id="modeNeon" type="button">⚡ Night Neon</button>
          </div>
          <div class="pill" title="Status koneksi API">
            <span id="apiDot" class="dot"></span>
            <span id="apiStatus">Connecting…</span>
          </div>
          <div class="pill" title="Sinkron terakhir (WIB)">
            <span>Last sync</span>
            <b id="lastSync" style="color:var(--text)">—</b>
          </div>
          <button id="btnRefresh" class="btn">Refresh</button>
          <button id="btnLogout" class="btn">Logout</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div class="grid kpis" style="margin-top: 14px;">
        <div class="card"><div class="cardInner">
          <div class="kpiTitle">Total Revenue</div>
          <div id="kpiRevenue" class="kpiValue">Rp 0</div>
          <div class="kpiSub"><span>Total masuk</span><span id="kpiRevHint" class="badge">All time</span></div>
        </div></div>

        <div class="card"><div class="cardInner">
          <div class="kpiTitle">Total Qty</div>
          <div id="kpiQty" class="kpiValue">0</div>
          <div class="kpiSub"><span>Jumlah item/qty</span><span id="kpiQtyHint" class="badge">All time</span></div>
        </div></div>

        <div class="card"><div class="cardInner">
          <div class="kpiTitle">Transaksi Sukses</div>
          <div id="kpiTrx" class="kpiValue">0</div>
          <div class="kpiSub"><span>Total transaksi</span><span id="kpiTrxHint" class="badge">All time</span></div>
        </div></div>

        <div class="card"><div class="cardInner">
          <div class="kpiTitle">Area Coverage</div>
          <div id="kpiCov" class="kpiValue">0</div>
          <div class="kpiSub"><span>Jumlah coverage</span><span id="kpiCovHint" class="badge">All time</span></div>
        </div></div>
      </div>

      <div style="height: 14px;"></div>
      <div class="grid growth">
        <div class="card"><div class="cardInner">
          <div class="growHeader">
            <div><div class="h">Growth Harian</div><div class="small">Hari ini vs kemarin</div></div>
            <span id="gDayBadge" class="badge">—</span>
          </div>
          <div class="growMeta">
            <div class="growRow"><span>Revenue</span><b id="gDayRev">Rp 0</b></div>
            <div class="growRow"><span>Qty</span><b id="gDayQty">0</b></div>
            <div class="growRow"><span>Transaksi</span><b id="gDayTrx">0</b></div>
          </div>
        </div></div>

        <div class="card"><div class="cardInner">
          <div class="growHeader">
            <div><div class="h">Growth Mingguan</div><div class="small">Minggu ini vs minggu kemarin</div></div>
            <span id="gWeekBadge" class="badge">—</span>
          </div>
          <div class="growMeta">
            <div class="growRow"><span>Revenue</span><b id="gWeekRev">Rp 0</b></div>
            <div class="growRow"><span>Qty</span><b id="gWeekQty">0</b></div>
            <div class="growRow"><span>Transaksi</span><b id="gWeekTrx">0</b></div>
          </div>
        </div></div>

        <div class="card"><div class="cardInner">
          <div class="growHeader">
            <div><div class="h">Growth Bulanan</div><div class="small">Bulan ini vs bulan kemarin</div></div>
            <span id="gMonthBadge" class="badge">—</span>
          </div>
          <div class="growMeta">
            <div class="growRow"><span>Revenue</span><b id="gMonthRev">Rp 0</b></div>
            <div class="growRow"><span>Qty</span><b id="gMonthQty">0</b></div>
            <div class="growRow"><span>Transaksi</span><b id="gMonthTrx">0</b></div>
          </div>
        </div></div>

        <div class="card"><div class="cardInner">
          <div class="growHeader">
            <div><div class="h">Growth Tahunan</div><div class="small">Tahun ini vs tahun kemarin</div></div>
            <span id="gYearBadge" class="badge">—</span>
          </div>
          <div class="growMeta">
            <div class="growRow"><span>Revenue</span><b id="gYearRev">Rp 0</b></div>
            <div class="growRow"><span>Qty</span><b id="gYearQty">0</b></div>
            <div class="growRow"><span>Transaksi</span><b id="gYearTrx">0</b></div>
          </div>
        </div></div>
      </div>

      <div style="height: 14px;"></div>
      <div class="grid charts">
        <div class="card">
          <div class="chartWrap">
            <div class="chartTitle">
              <h3>Revenue & Qty Trend</h3>
              <div class="filters" id="rangeChips">
                <span class="chip active" data-range="7d">7D</span>
                <span class="chip" data-range="30d">30D</span>
                <span class="chip" data-range="mtd">MTD</span>
                <span class="chip" data-range="ytd">YTD</span>
                <span class="chip" data-range="all">ALL</span>
              </div>
            </div>
            <canvas id="revChart" height="110"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="chartWrap">
            <div class="chartTitle">
              <h3>Transaksi (Bar)</h3>
              <div class="small" id="chartHint">—</div>
            </div>
            <canvas id="trxChart" height="140"></canvas>
          </div>
        </div>
      </div>

      <div style="height: 14px;"></div>
      <div class="card">
        <div class="tableHead">
          <h3>Transaksi Terbaru</h3>
          <div class="tableTools">
            <input id="searchBox" class="inp" placeholder="Cari nama / order / metode…">
            <button id="btnExport" class="btn">Export CSV</button>
          </div>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">Waktu (WIB)</th>
                <th style="width:170px;">No Order</th>
                <th style="width:140px;">Nama</th>
                <th style="width:120px;">Metode</th>
                <th class="right" style="width:80px;">Qty</th>
                <th class="right" style="width:140px;">Rp</th>
                <th class="right" style="width:90px;">Coverage</th>
                <th style="width:130px;">Bukti</th>
                <th>Ringkasan</th>
              </tr>
            </thead>
            <tbody id="trxBody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer">© 2026 — Brand Retail Cortex.io<br>Crafted by D&D A Digital Creative Studio</div>
    </div>
  </div>

  <div id="toast" class="toast">Updated</div>

<script>
(() => {
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVYtlHNmyZzQk4NZRT1onJPEFD1eNmt37fjffka0BJ0UNob03bFcyGovzQ4wKkVhgnKQ/exec";

  const OWNER_USER = "brandon26";
  const OWNER_PIN  = "262626";

  const $ = (id) => document.getElementById(id);

  function setTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("rc_theme", theme);
    const isLight = theme === "light";
    $("modeLight").classList.toggle("active", isLight);
    $("modeNeon").classList.toggle("active", !isLight);
  }
  function toggleTheme() {
    const cur = document.documentElement.getAttribute("data-theme") || "neon";
    setTheme(cur === "light" ? "neon" : "light");
    rebuildChartsOnTheme();
  }

  const savedTheme = localStorage.getItem("rc_theme") || "neon";
  setTheme(savedTheme);

  $("btnTheme").addEventListener("click", toggleTheme);
  $("modeLight").addEventListener("click", () => { setTheme("light"); rebuildChartsOnTheme(); });
  $("modeNeon").addEventListener("click", () => { setTheme("neon"); rebuildChartsOnTheme(); });

  function isLoggedIn() { return localStorage.getItem("rc_owner_ok") === "1"; }
  function showApp() { $("loginPage").style.display = "none"; $("app").style.display = "block"; }
  function showLogin() { $("app").style.display = "none"; $("loginPage").style.display = "flex"; }

  $("btnLogin").addEventListener("click", () => {
    const u = ($("username").value || "").trim();
    const p = ($("pin").value || "").trim();
    const err = $("loginErr");

    if (u === OWNER_USER && p === OWNER_PIN) {
      localStorage.setItem("rc_owner_ok", "1");
      err.style.display = "none";
      showApp();
      refreshAll();
    } else {
      err.textContent = "Username / PIN salah.";
      err.style.display = "block";
    }
  });

  $("btnLogout").addEventListener("click", () => { localStorage.removeItem("rc_owner_ok"); showLogin(); });

  if (isLoggedIn()) showApp(); else showLogin();

  const rupiah = (n) => "Rp " + Number(n||0).toLocaleString("id-ID");

  function toast(msg) {
    const t = $("toast");
    t.textContent = msg || "Updated";
    t.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(() => (t.style.display = "none"), 1800);
  }

  function setApiStatus(ok, msg) {
    const dot = $("apiDot");
    dot.classList.remove("ok", "bad");
    dot.classList.add(ok ? "ok" : "bad");
    $("apiStatus").textContent = msg || (ok ? "Connected" : "Disconnected");
  }

  function parseWIB(ts) {
    const s = String(ts || "").replace("(WIB)", "").trim();
    const parts = s.split(" ");
    if (parts.length < 2) return null;
    const [d, m, y] = parts[0].split("/").map(x=>parseInt(x,10));
    const [hh, mm, ss] = parts[1].split(":").map(x=>parseInt(x,10));
    if (!d || !m || !y) return null;
    const dt = new Date(Date.UTC(y, m-1, d, hh||0, mm||0, ss||0));
    dt._wib = { y, m, d, hh:hh||0, mm:mm||0, ss:ss||0 };
    return dt;
  }
  function ymdKey(dt) {
    if (!dt) return "";
    const w = dt._wib;
    return `${w.y}-${String(w.m).padStart(2,"0")}-${String(w.d).padStart(2,"0")}`;
  }
  function weekKeyISO(dt) {
    if (!dt) return "0000-W00";
    const w = dt._wib;
    const date = new Date(Date.UTC(w.y, w.m-1, w.d, 12, 0, 0));
    const day = (date.getUTCDay() + 6) % 7;
    date.setUTCDate(date.getUTCDate() - day + 3);
    const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4,12,0,0));
    const firstDay = (firstThu.getUTCDay() + 6) % 7;
    firstThu.setUTCDate(firstThu.getUTCDate() - firstDay + 3);
    const week = 1 + Math.round((date - firstThu) / (7*24*3600*1000));
    const year = date.getUTCFullYear();
    return `${year}-W${String(week).padStart(2,"0")}`;
  }

  function extractRevenue(text) {
    const s = String(text||"").replace(/\./g,"").replace(/,/g,"");
    const m = s.match(/\bRP\b\s*(\d+)/i);
    return m ? Number(m[1]) : 0;
  }
  function extractQty(text) {
    const s = String(text||"");
    const m = s.match(/(?:TOTAL\s*QTY|JUMLAH\s*QTY|QTY\s*MEMBER)\s*[:\-]?\s*(\d+)/i);
    if (m) return Number(m[1]) || 0;
    const mx = s.match(/(\d+)\s*x/gi);
    let q = 0;
    if (mx) mx.forEach(t => q += Number(t.replace(/\D/g,"")) || 0);
    return q;
  }
  function extractCoverage(text) {
    const s = String(text||"");
    return /area\s*coverage|coverage|area\s*cov|cov\s*area/i.test(s) ? 1 : 0;
  }

  function calcGrowth(cur, prev) {
    cur = Number(cur||0); prev = Number(prev||0);
    if (prev === 0 && cur === 0) return { cls:"badge", txt:"0%" };
    if (prev === 0) return { cls:"badge good", txt:"+∞" };
    const pct = ((cur - prev) / prev) * 100;
    const sign = pct > 0 ? "+" : "";
    const cls = pct > 0 ? "badge good" : (pct < 0 ? "badge bad" : "badge");
    return { cls, txt: `${sign}${pct.toFixed(1)}%` };
  }

  let revChart=null, trxChart=null;
  function buildCharts(labels, revenue, trxCounts, qtySeries) {
    const isLight = (document.documentElement.getAttribute("data-theme")==="light");
    const isMobile = window.matchMedia("(max-width: 640px)").matches;

    const gridColor = isLight ? "rgba(15,23,42,.10)" : "rgba(255,255,255,.10)";
    const tickColor = isLight ? "rgba(15,23,42,.70)" : "rgba(255,255,255,.70)";
    const accent = getComputedStyle(document.documentElement).getPropertyValue("--accent").trim() || "#22d3ee";
    const accent2 = getComputedStyle(document.documentElement).getPropertyValue("--accent2").trim() || "#8b5cf6";
    const good = getComputedStyle(document.documentElement).getPropertyValue("--good").trim() || "#22c55e";

    const ctx = document.getElementById("revChart").getContext("2d");
    if (revChart) revChart.destroy();
    if (trxChart) trxChart.destroy();

    // === MAIN: COMBO (BAR Revenue + LINE Qty) — no curva fill, mobile-friendly
    revChart = new Chart(ctx, {
      type:"bar",
      data:{
        labels,
        datasets:[
          {
            type:"bar",
            label:"Revenue (Rp)",
            data:revenue,
            backgroundColor: isLight ? "rgba(37,99,235,.30)" : "rgba(46,233,255,.16)",
            borderColor: accent,
            borderWidth: 1,
            borderRadius: 10,
            barPercentage: 0.78,
            categoryPercentage: 0.70
          },
          {
            type:"line",
            label:"Qty",
            data:qtySeries,
            yAxisID:"y1",
            borderColor: good,
            backgroundColor: good,
            borderWidth: 2,
            tension: .35,
            pointRadius: isMobile ? 0 : 2,
            pointHoverRadius: isMobile ? 2 : 4
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:"index", intersect:false },
        plugins:{
          legend:{ display: !isMobile, labels:{ color: tickColor, boxWidth:10, boxHeight:10 } },
          tooltip:{
            callbacks:{
              label: (ctx) => {
                const v = ctx.raw ?? 0;
                if (ctx.dataset.type === "bar") return ` Revenue: Rp ${Number(v).toLocaleString("id-ID")}`;
                return ` Qty: ${Number(v).toLocaleString("id-ID")}`;
              }
            }
          }
        },
        scales:{
          x:{ ticks:{color:tickColor, maxRotation:0, autoSkip:true}, grid:{color:"transparent"} },
          y:{
            beginAtZero:true,
            ticks:{
              color:tickColor,
              callback:(v)=> (v>=1e9?(v/1e9).toFixed(1)+"B":v>=1e6?(v/1e6).toFixed(1)+"M":v>=1e3?(v/1e3).toFixed(0)+"K":v)
            },
            grid:{color: gridColor}
          },
          y1:{
            beginAtZero:true,
            position:"right",
            ticks:{ color:tickColor },
            grid:{ drawOnChartArea:false }
          }
        }
      }
    });

    // === SECONDARY: TRANSAKSI per hari (BAR) — clean
    const ctx2 = document.getElementById("trxChart").getContext("2d");
    trxChart = new Chart(ctx2, {
      type:"bar",
      data:{
        labels,
        datasets:[{
          label:"Transaksi",
          data:trxCounts,
          backgroundColor: isLight ? "rgba(124,58,237,.18)" : "rgba(155,92,255,.22)",
          borderColor: accent2,
          borderWidth: 1,
          borderRadius: 10,
          barPercentage: 0.78,
          categoryPercentage: 0.70
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false} },
        scales:{
          x:{ ticks:{color:tickColor, maxRotation:0, autoSkip:true}, grid:{color:"transparent"} },
          y:{ beginAtZero:true, ticks:{color:tickColor, precision:0}, grid:{color:gridColor} }
        }
      }
    });
  }

  function escapeHtml(s) {
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  let latestRows = [];
  function renderTable(rows, query) {
    const q = (query||"").toLowerCase().trim();
    const body = $("trxBody");
    body.innerHTML = "";
    const filtered = rows.filter(r => !q || (String(r.order||"").toLowerCase().includes(q) || String(r.nama||"").toLowerCase().includes(q) || String(r.metode||"").toLowerCase().includes(q) || String(r.ringkasan||"").toLowerCase().includes(q)));
    const frag = document.createDocumentFragment();
    filtered.slice(0,200).forEach(r => {
      const qty = r.qty ?? extractQty(r.ringkasan);
      const rp  = r.rp  ?? extractRevenue(r.ringkasan);
      const cov = r.cov ?? extractCoverage(r.ringkasan);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono small">${escapeHtml(r.time||"")}</td>
        <td class="mono">${escapeHtml(r.order||"")}</td>
        <td>${escapeHtml(r.nama||"")}</td>
        <td>${escapeHtml(r.metode||"")}</td>
        <td class="right"><b>${Number(qty||0).toLocaleString("id-ID")}</b></td>
        <td class="right"><b>${rupiah(rp)}</b></td>
        <td class="right"><span class="badge ${cov? "good":"badge"}">${cov? "1":"0"}</span></td>
        <td>${r.buktiUrl ? `<a class="linkBtn" href="${r.buktiUrl}" target="_blank" rel="noopener">View Bukti ↗</a>` : `<span class="small">—</span>`}</td>
        <td class="summary">${escapeHtml(r.ringkasan||"")}</td>
      `;
      frag.appendChild(tr);
    });
    body.appendChild(frag);
  }

  function exportCSV(rows) {
    const headers = ["Waktu (WIB)","No Order","Nama","Metode","Qty","Rp","Coverage","Link Bukti","Ringkasan"];
    const lines = [headers.join(",")];
    rows.forEach(r => {
      const qty = r.qty ?? extractQty(r.ringkasan);
      const rp  = r.rp  ?? extractRevenue(r.ringkasan);
      const cov = r.cov ?? extractCoverage(r.ringkasan);
      const vals = [r.time||"", r.order||"", r.nama||"", r.metode||"", String(qty||0), String(rp||0), String(cov||0), r.buktiUrl||"", (r.ringkasan||"").replace(/\n/g," ")].map(v => `"${String(v).replaceAll('"','""')}"`);
      lines.push(vals.join(","));
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "retail-cortex-transaksi.csv";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1200);
  }

  let chartRange = "7d";
  function filterRange(labels, revenue, trxCounts, qtySeries) {
    if (chartRange === "all") return {labels, revenue, trxCounts, qtySeries};
    const lastN = (n) => {
      const start = Math.max(0, labels.length - n);
      return { labels: labels.slice(start), revenue: revenue.slice(start), trxCounts: trxCounts.slice(start), qtySeries: qtySeries.slice(start) };
    };
    if (chartRange === "7d") return lastN(7);
    if (chartRange === "30d") return lastN(30);
    if (chartRange === "mtd" || chartRange === "ytd") {
      if (!labels.length) return {labels, revenue, trxCounts, qtySeries};
      const last = labels[labels.length-1];
      const [Y,M] = last.split("-").map(x=>parseInt(x,10));
      const prefix = chartRange==="mtd" ? `${Y}-${String(M).padStart(2,"0")}-` : `${Y}-`;
      const startIdx = labels.findIndex(l => l.startsWith(prefix));
      const start = startIdx>=0 ? startIdx : 0;
      return { labels: labels.slice(start), revenue: revenue.slice(start), trxCounts: trxCounts.slice(start), qtySeries: qtySeries.slice(start) };
    }
    return {labels, revenue, trxCounts, qtySeries};
  }

  function computeAggregates(transaksi) {
    const perDay = new Map();
    const perWeek = new Map();
    const perMonth = new Map();
    const perYear = new Map();
    let totalRev=0, totalQty=0, totalTrx=0, totalCov=0;

    const add = (map, key, rp, qty, cov) => {
      if (!key) return;
      const obj = map.get(key) || {rev:0, qty:0, trx:0, cov:0};
      obj.rev += rp; obj.qty += qty; obj.trx += 1; obj.cov += cov;
      map.set(key, obj);
    };

    transaksi.forEach(t => {
      const dt = parseWIB(t.time);
      const day = ymdKey(dt);
      const week = weekKeyISO(dt);
      const w = dt? dt._wib : null;
      const month = w ? `${w.y}-${String(w.m).padStart(2,"0")}` : "";
      const year = w ? String(w.y) : "";

      const rp = t.rp ?? extractRevenue(t.ringkasan);
      const qty = t.qty ?? extractQty(t.ringkasan);
      const cov = t.cov ?? extractCoverage(t.ringkasan);

      totalRev += rp; totalQty += qty; totalTrx += 1; totalCov += cov;

      add(perDay, day, rp, qty, cov);
      add(perWeek, week, rp, qty, cov);
      add(perMonth, month, rp, qty, cov);
      add(perYear, year, rp, qty, cov);
    });

    return { totalRev, totalQty, totalTrx, totalCov, perDay, perWeek, perMonth, perYear };
  }

  function getLatestKey(map) {
    const keys = Array.from(map.keys()).filter(Boolean).sort();
    return keys[keys.length-1] || "";
  }
  function getPrevKey(key, kind) {
    if (!key) return "";
    if (kind==="day") {
      const [Y,M,D] = key.split("-").map(n=>parseInt(n,10));
      const dt = new Date(Date.UTC(Y, M-1, D));
      dt.setUTCDate(dt.getUTCDate()-1);
      return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,"0")}-${String(dt.getUTCDate()).padStart(2,"0")}`;
    }
    if (kind==="month") {
      const [Y,M] = key.split("-").map(n=>parseInt(n,10));
      let y=Y, m=M-1;
      if (m===0) { y=Y-1; m=12; }
      return `${y}-${String(m).padStart(2,"0")}`;
    }
    if (kind==="year") return String(parseInt(key,10)-1);
    if (kind==="week") {
      const [Y,W] = key.split("-W");
      const year=parseInt(Y,10), week=parseInt(W,10);
      if (week>1) return `${year}-W${String(week-1).padStart(2,"0")}`;
      return `${year-1}-W52`;
    }
    return "";
  }

  function applyGrowth(prefix, cur, prev) {
    const g = calcGrowth(cur.rev, prev.rev);
    const badge = $(prefix+"Badge");
    badge.className = g.cls;
    badge.textContent = g.txt;

    $(prefix+"Rev").textContent = rupiah(cur.rev);
    $(prefix+"Qty").textContent = Number(cur.qty).toLocaleString("id-ID");
    $(prefix+"Trx").textContent = Number(cur.trx).toLocaleString("id-ID");
  }

  function animateNumber(elId, target, isRp) {
    const el = $(elId);
    const end = Number(target||0);
    const dur = 650;
    const t0 = performance.now();
    const start = 0;
    function frame(t) {
      const p = Math.min(1, (t - t0) / dur);
      const eased = 1 - Math.pow(1 - p, 3);
      const val = Math.round(start + (end - start) * eased);
      el.textContent = isRp ? rupiah(val) : val.toLocaleString("id-ID");
      if (p < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  async function fetchDashboard() {
    const url = APPS_SCRIPT_URL + "?mode=dashboard&_=" + Date.now();
    const res = await fetch(url, { method:"GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  function normalizeFromAPI(api) {
    const list = Array.isArray(api?.transaksi) ? api.transaksi : [];
    return list.map(t => ({
      time: t.time || t.waktu || "",
      nama: t.nama || "",
      metode: t.metode || "",
      order: t.order || t.noOrder || "",
      ringkasan: t.ringkasan || "",
      buktiUrl: t.buktiUrl || t.bukti || ""
    }));
  }

  function updateUI(transaksi) {
    const agg = computeAggregates(transaksi);

    animateNumber("kpiRevenue", agg.totalRev, true);
    animateNumber("kpiQty", agg.totalQty, false);
    animateNumber("kpiTrx", agg.totalTrx, false);
    animateNumber("kpiCov", agg.totalCov, false);

    const dayKey = getLatestKey(agg.perDay);
    const weekKey = getLatestKey(agg.perWeek);
    const monthKey = getLatestKey(agg.perMonth);
    const yearKey = getLatestKey(agg.perYear);

    const get = (map, key) => map.get(key) || {rev:0, qty:0, trx:0, cov:0};

    applyGrowth("gDay", get(agg.perDay, dayKey), get(agg.perDay, getPrevKey(dayKey,"day")));
    applyGrowth("gWeek", get(agg.perWeek, weekKey), get(agg.perWeek, getPrevKey(weekKey,"week")));
    applyGrowth("gMonth", get(agg.perMonth, monthKey), get(agg.perMonth, getPrevKey(monthKey,"month")));
    applyGrowth("gYear", get(agg.perYear, yearKey), get(agg.perYear, getPrevKey(yearKey,"year")));

    const labels = Array.from(agg.perDay.keys()).filter(Boolean).sort();
    const revenue = labels.map(k => agg.perDay.get(k).rev);
    const trxCounts = labels.map(k => agg.perDay.get(k).trx);
    const qtySeries = labels.map(k => agg.perDay.get(k).qty);

    const sliced = filterRange(labels, revenue, trxCounts, qtySeries);
    buildCharts(sliced.labels, sliced.revenue, sliced.trxCounts, sliced.qtySeries);

    $("chartHint").textContent = labels.length ? `Data hari: ${labels.length}` : "—";

    latestRows = transaksi.slice().sort((a,b) => (parseWIB(b.time)?.getTime()||0) - (parseWIB(a.time)?.getTime()||0));
    renderTable(latestRows, $("searchBox").value || "");
  }

  async function refreshAll() {
    try {
      setApiStatus(false, "Connecting…");
      const api = await fetchDashboard();
      const transaksi = normalizeFromAPI(api);
      setApiStatus(true, "Connected");

      const ts = new Date();
      const wib = new Intl.DateTimeFormat("id-ID", {
        timeZone: "Asia/Jakarta",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      }).format(ts).replace(",", "") + " WIB";
      $("lastSync").textContent = wib;

      updateUI(transaksi);
      toast("Data updated");
    } catch (e) {
      console.error(e);
      setApiStatus(false, "Disconnected");
      toast("Gagal ambil data");
    }
  }

  function rebuildChartsOnTheme() {
    if (!latestRows.length) return;
    const agg = computeAggregates(latestRows);
    const labels = Array.from(agg.perDay.keys()).filter(Boolean).sort();
    const revenue = labels.map(k => agg.perDay.get(k).rev);
    const trxCounts = labels.map(k => agg.perDay.get(k).trx);
    const qtySeries = labels.map(k => agg.perDay.get(k).qty);
    const sliced = filterRange(labels, revenue, trxCounts, qtySeries);
    buildCharts(sliced.labels, sliced.revenue, sliced.trxCounts, sliced.qtySeries);
  }

  document.querySelectorAll("#rangeChips .chip").forEach(chip => {
    chip.addEventListener("click", () => {
      document.querySelectorAll("#rangeChips .chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      chartRange = chip.getAttribute("data-range") || "7d";
      rebuildChartsOnTheme();
    });
  });

  $("btnRefresh").addEventListener("click", refreshAll);
  $("searchBox").addEventListener("input", () => renderTable(latestRows, $("searchBox").value));
  $("btnExport").addEventListener("click", () => exportCSV(latestRows));

  if (isLoggedIn()) refreshAll();
})();
</script>
</body>
</html>